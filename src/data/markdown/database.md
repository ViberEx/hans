# 数据库

深入了解如何在 Lovable 中使用 PostgreSQL 数据库存储和管理数据。

## 前提条件

确保已启用 [Lovable Cloud](lovable-cloud)。

## 创建数据表

### 通过对话创建

```
创建一个商品表，包含：
- 名称（必填）
- 价格（数字类型）
- 描述（文本）
- 图片 URL
- 是否在售（布尔值，默认 true）
- 创建时间（自动）
```

Lovable 会：
1. 创建数据表结构
2. 生成前端查询代码
3. 配置基本的 RLS 策略

### 查看表结构

在 Cloud → Database 中：
- 查看所有表
- 查看每个表的字段
- 查看索引和约束

## 数据类型

### 常用类型

| 类型 | 说明 | 示例 |
|------|------|------|
| `text` | 文本 | 用户名、描述 |
| `integer` | 整数 | 年龄、数量 |
| `decimal` | 小数 | 价格、评分 |
| `boolean` | 布尔值 | 是否启用 |
| `timestamp` | 时间戳 | 创建时间 |
| `uuid` | 唯一标识 | 用户 ID |
| `json` | JSON 数据 | 复杂配置 |

### 特殊字段

```
添加以下特殊字段：
- id: 自动生成的 UUID，作为主键
- created_at: 创建时间，自动设置
- updated_at: 更新时间，自动更新
- user_id: 关联到当前登录用户
```

## CRUD 操作

### 读取 (Read)

#### 获取所有记录

```
显示商品列表，从数据库加载所有商品
```

生成的代码示例：

```tsx
const { data: products } = useQuery({
  queryKey: ['products'],
  queryFn: async () => {
    const { data } = await supabase
      .from('products')
      .select('*');
    return data;
  },
});
```

#### 筛选查询

```
只显示在售的商品，按价格从低到高排序
```

#### 单条记录

```
显示商品详情页，根据 ID 获取单个商品信息
```

### 创建 (Create)

```
添加新商品的表单，包含所有必填字段，
提交后保存到数据库
```

生成的代码示例：

```tsx
const mutation = useMutation({
  mutationFn: async (newProduct) => {
    const { data } = await supabase
      .from('products')
      .insert([newProduct]);
    return data;
  },
});
```

### 更新 (Update)

```
添加编辑商品功能，可以修改名称、价格和描述
```

### 删除 (Delete)

```
添加删除按钮，删除前弹出确认对话框
```

## 表关系

### 一对多关系

```
创建订单系统：
- 订单表：订单 ID、用户 ID、总价、状态
- 订单项表：订单项 ID、订单 ID、商品 ID、数量

一个订单包含多个订单项
```

### 多对多关系

```
创建标签系统：
- 文章表
- 标签表
- 文章标签关联表

一篇文章可以有多个标签，一个标签可以属于多篇文章
```

### 关联查询

```
显示订单列表时，同时显示：
- 用户信息
- 订单项详情
- 每个订单项的商品信息
```

## 行级安全 (RLS)

### 什么是 RLS

行级安全策略控制用户可以访问哪些数据行。

### 常见策略

#### 用户只能访问自己的数据

```
配置权限：用户只能查看和修改自己创建的文章
```

生成的策略：

```sql
-- 读取策略
CREATE POLICY "用户可以查看自己的文章"
ON articles FOR SELECT
USING (auth.uid() = user_id);

-- 写入策略
CREATE POLICY "用户可以编辑自己的文章"
ON articles FOR UPDATE
USING (auth.uid() = user_id);
```

#### 公开读取，限制写入

```
配置权限：
- 所有人可以查看商品
- 只有管理员可以添加/修改商品
```

#### 基于角色的权限

```
添加角色系统：
- 普通用户可以评论
- 管理员可以删除任何评论
- 版主可以编辑评论
```

### 查看和修改 RLS

在 Cloud → Database 中：
1. 选择数据表
2. 点击 "RLS Policies"
3. 查看现有策略
4. 可以手动添加新策略

## 数据验证

### 前端验证

```
添加表单验证：
- 商品名称不能为空
- 价格必须大于 0
- 描述最多 500 字
```

### 数据库约束

```
在数据库层面添加约束：
- 邮箱字段唯一
- 价格字段不能为负数
- 必填字段不能为 null
```

## 实时订阅

### 监听数据变化

```
实现实时功能：当有新商品添加时，列表自动更新
```

生成的代码示例：

```tsx
useEffect(() => {
  const channel = supabase
    .channel('products')
    .on('postgres_changes', 
      { event: 'INSERT', schema: 'public', table: 'products' },
      (payload) => {
        // 处理新数据
      }
    )
    .subscribe();

  return () => {
    supabase.removeChannel(channel);
  };
}, []);
```

## 性能优化

### 添加索引

```
为常用查询字段添加索引：
- 商品表的分类字段
- 用户表的邮箱字段
```

### 分页加载

```
商品列表改为分页显示，每页 20 条，
添加 "加载更多" 按钮
```

### 查询优化

```
优化订单查询：
- 只获取必要的字段
- 使用 join 减少查询次数
- 添加缓存
```

## 数据迁移

### 添加新字段

```
在商品表中添加新字段：
- 库存数量（整数，默认 0）
- 销量（整数，默认 0）
```

### 修改字段类型

```
将价格字段从整数改为小数，保留两位小数
```

### 数据清理

在 Cloud → Database 中可以：
- 导出数据 (CSV)
- 批量删除
- SQL 查询

## 最佳实践

### 1. 命名规范

- 表名使用小写复数：`products`, `users`
- 字段名使用 snake_case：`created_at`, `user_id`
- 外键命名：`[表名]_id`

### 2. 字段设计

- 总是包含 `id` 主键
- 添加 `created_at` 时间戳
- 必要时添加 `updated_at`
- 软删除使用 `deleted_at`

### 3. 安全性

- 始终启用 RLS
- 默认拒绝所有访问
- 仅开放必要权限
- 验证用户输入

### 4. 性能

- 为常查询字段添加索引
- 避免 SELECT *
- 使用合适的数据类型
- 考虑分页

## 故障排查

### 数据未显示

检查：
- RLS 策略是否正确
- 用户是否已登录（如果需要）
- 查询条件是否正确

### 写入失败

检查：
- 必填字段是否都有值
- 数据类型是否匹配
- RLS 是否允许写入
- 是否违反了唯一约束

### 性能问题

- 查看慢查询日志
- 检查是否缺少索引
- 考虑添加缓存
- 优化查询逻辑

## 下一步

- 🔐 学习 [用户认证](authentication)
- 🚀 准备 [部署应用](deployment)
- 📚 查看 Supabase 官方文档（高级功能）
