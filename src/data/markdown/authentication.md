# 用户认证

了解如何在 Lovable 应用中实现用户登录、注册和权限管理。

## 前提条件

确保已启用 [Lovable Cloud](lovable-cloud)。

## 添加认证功能

### 基础认证

```
添加用户登录功能：
- 注册页面（邮箱 + 密码）
- 登录页面
- 退出登录功能
```

Lovable 会自动创建：
- `/login` 登录页面
- `/signup` 注册页面
- 认证状态管理
- 受保护的路由

### 查看认证配置

在 Cloud → Authentication 中：
- 查看已注册用户
- 配置认证方式
- 设置邮箱模板
- 查看登录日志

## 认证方式

### 邮箱 + 密码

默认方式，自动包含：

- ✅ 邮箱验证
- ✅ 忘记密码
- ✅ 重置密码
- ✅ 修改密码

### 魔法链接

无需密码，通过邮件登录：

```
改为使用魔法链接登录：
用户输入邮箱后，收到登录链接
```

### 手机号 + 验证码

```
添加手机号登录功能，发送验证码
```

需要配置 SMS 服务商。

### OAuth 登录

```
添加第三方登录按钮：
- Google
- GitHub
```

#### 配置 OAuth

1. 在 Cloud → Authentication → Providers 中
2. 启用对应的提供商
3. 输入 Client ID 和 Secret
4. 配置回调 URL

## 保护路由

### 需要登录才能访问

```
创建个人中心页面，只有登录用户可以访问，
未登录则重定向到登录页
```

生成的代码示例：

```tsx
function ProtectedPage() {
  const { data: user } = useQuery({
    queryKey: ['user'],
    queryFn: async () => {
      const { data: { user } } = await supabase.auth.getUser();
      return user;
    },
  });

  if (!user) {
    return <Navigate to="/login" />;
  }

  return <div>个人中心内容</div>;
}
```

### 已登录重定向

```
如果用户已登录，访问登录页时自动跳转到首页
```

## 用户信息

### 获取当前用户

```tsx
const { data: user } = useQuery({
  queryKey: ['user'],
  queryFn: async () => {
    const { data: { user } } = await supabase.auth.getUser();
    return user;
  },
});

// user 包含：
// - id: 用户 ID
// - email: 邮箱
// - created_at: 注册时间
```

### 显示用户信息

```
在导航栏显示用户头像和名称，
点击显示下拉菜单（个人中心、设置、退出）
```

### 用户资料

创建用户资料表：

```
创建 profiles 表，存储用户额外信息：
- user_id (关联 auth.users)
- 昵称
- 头像 URL
- 个人简介
- 创建时间

注册时自动创建对应的 profile
```

## 权限管理

### 基于用户的权限

```
配置权限：
- 用户只能编辑自己的资料
- 用户只能查看自己的订单
```

### 角色系统

```
实现角色管理：
- admin: 管理员（所有权限）
- moderator: 版主（审核内容）
- user: 普通用户（基础权限）

在 profiles 表添加 role 字段
```

#### 角色检查示例

```tsx
const { data: profile } = useQuery({
  queryKey: ['profile'],
  queryFn: async () => {
    const { data } = await supabase
      .from('profiles')
      .select('role')
      .single();
    return data;
  },
});

const isAdmin = profile?.role === 'admin';
```

### 条件显示内容

```
只有管理员可以看到删除按钮
```

```tsx
{isAdmin && (
  <Button variant="destructive" onClick={handleDelete}>
    删除
  </Button>
)}
```

## 邮件配置

### 自定义邮件模板

在 Cloud → Authentication → Email Templates 中：

- 欢迎邮件
- 邮箱验证
- 忘记密码
- 魔法链接

可自定义：
- 邮件主题
- 邮件内容（HTML）
- 发件人名称

### 配置 SMTP

默认使用 Lovable 的邮件服务。

如需使用自己的 SMTP：
1. 在设置中配置 SMTP 服务器
2. 验证发件地址
3. 更新邮件模板

## 会话管理

### 会话持久化

默认行为：
- 用户登录后，会话保持
- 关闭浏览器后仍保持登录
- 可手动退出登录

### 会话过期

```
配置会话：
- 30 天后自动过期
- 过期后要求重新登录
```

### 多设备登录

支持同时在多个设备登录。

```
查看所有活跃会话，可以远程登出其他设备
```

## 安全性

### 密码要求

默认要求：
- 最少 6 位
- 无特殊字符要求

可配置更严格的规则：

```
密码要求：
- 至少 8 位
- 包含大小写字母
- 包含数字
- 包含特殊字符
```

### 登录限制

```
添加安全功能：
- 5 次登录失败后锁定账号 10 分钟
- 记录登录 IP 和设备信息
```

### 两步验证

```
添加两步验证功能，支持 TOTP
```

需要集成第三方 TOTP 库。

## 社交账号绑定

### 绑定多个登录方式

```
允许用户绑定多个登录方式：
- 用邮箱注册的用户可以绑定 Google
- 用 Google 登录的用户可以设置密码
```

### 账号合并

```
如果用户使用不同方式登录但邮箱相同，
提示是否合并账号
```

## 实际场景

### 场景 1: 基础应用

```
创建笔记应用：
- 邮箱密码登录
- 未登录可以浏览公开笔记
- 登录后可以创建私人笔记
```

### 场景 2: 社交应用

```
创建社区论坛：
- 支持 Google 和 GitHub 登录
- 登录后设置昵称和头像
- 根据角色显示不同功能
```

### 场景 3: SaaS 应用

```
创建项目管理工具：
- 团队邀请注册
- 邮箱验证必需
- 角色权限控制（所有者、成员、访客）
```

## 常见问题

### Q: 如何修改注册后的重定向页面？

```
注册成功后跳转到引导页面，而不是首页
```

### Q: 如何实现 "记住我" 功能？

默认已实现，会话会持久化。

### Q: 如何获取用户的其他信息？

创建 profiles 表关联用户 ID：

```
JOIN profiles ON profiles.user_id = auth.uid()
```

### Q: 如何实现邀请码注册？

```
添加邀请码功能：
- 生成唯一邀请码
- 注册时验证邀请码
- 记录邀请关系
```

## 测试认证

### 创建测试账号

在 Cloud → Authentication 中：
1. 点击 "Add User"
2. 输入邮箱和密码
3. 可选择是否验证邮箱

### 切换账号测试

1. 退出当前账号
2. 用不同角色的账号登录
3. 验证权限是否正确

## 最佳实践

### 1. 安全优先

- 启用邮箱验证
- 使用强密码策略
- 正确配置 RLS
- 验证所有用户输入

### 2. 用户体验

- 清晰的错误提示
- 加载状态显示
- 记住登录状态
- 友好的邮件模板

### 3. 权限设计

- 默认最小权限
- 分离公开和私密数据
- 使用角色而非硬编码
- 定期审查权限

### 4. 数据关联

- 使用外键关联用户
- RLS 使用 auth.uid()
- 创建 profiles 扩展用户信息
- 考虑用户删除的影响

## 下一步

- 📊 深入学习 [数据库](database) 与用户关联
- 🚀 准备 [部署应用](deployment)
- 🔒 了解高级安全配置
